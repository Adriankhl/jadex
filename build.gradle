if(file('gradle.properties').exists())
{
	apply from: "gradle.properties"
}

//if(gradle.startParameter.taskRequests.args.size()>0 && gradle.startParameter.taskRequests.args[0].contains("upload"))
//{
//	println("upload detected")
//}

def stdexcl = ['-backup', '-management', '-maven', '-servletfilter-', '-jmonkey', 
	'-launch', '-web', '-distribution-', '-webservice', '-securetransport', '-relay'] //*:*-relay-standalone

def proexcl = ['-jmonkey', '-launch', '-web', '-distribution-', '-backup']

allprojects
{
	apply plugin: 'java-library-distribution'

    version = '2.5-SNAPSHOT'
    group = 'net.sourceforge.jadex'
    
    configurations
    {
        deployerJars
    }

    dependencies
    {
        deployerJars "org.apache.maven.wagon:wagon-ssh:2.2"
    }

    repositories
    {
        mavenCentral()
        //maven
        //{
        //    name 'www1'
        //    url 'http://www1.activecomponents.org/nexus/content/repositories/snapshots/'
        //    credentials
        //    {
        //        username 'deployment'
        //        password 'laxlax'
        //    }
        //}
    }
}

configurations
{
	excludeset
}

subprojects
{
	//ext.junit = "junit:junit:4.11"
    apply plugin: 'java'
    apply plugin: 'maven'
    //apply plugin: 'maven-publish'
    apply plugin: 'signing'
    //apply plugin: 'java-library-distribution'

    sourceCompatibility = 1.6
    sourceSets.main.resources.srcDirs    'src/main/java'
    sourceSets.test.resources.srcDirs    'src/test/java'

    dependencies
    {
        testCompile 'junit:junit:4.11'
    }
    
	task sourcesJar(type: Jar, dependsOn: classes) {
    	classifier 'sources'
    	from sourceSets.main.allSource
	}
	//sourcesJar.onlyIf { gradle.startParameter.taskRequests.args.size()>0 && gradle.startParameter.taskRequests.args[0].contains("upload") }

	task javadocJar(type: Jar) {
		classifier = 'javadoc'
		from javadoc.destinationDir
	} 
	javadocJar.onlyIf { gradle.startParameter.taskRequests.args.size()>0 && gradle.startParameter.taskRequests.args[0].contains("upload") }
 
	artifacts 
	{
    	archives sourcesJar
    	archives javadocJar
	}

	signing
	{
		if(project.hasProperty("ext.signing.keyId"))
		{
	    	sign configurations.archives
		}
	}

	// cannot sign with maven-publish :-( http://stackoverflow.com/questions/16560235/how-to-sign-maven-publications-with-gradle
    // publishing
    // {
    //    publications
    //    {
    //        mavenJava(MavenPublication)
    //        {
    //			from components.java
    //		
    //			artifact sourceJar {
    //            	classifier "sources"
    //        	}
    //		}
    //	}
   	//}

    //uploadArchives
    //{
    //    repositories
    //    {
    //        add project.repositories.www1
    //    }
    //}

    uploadArchives
    {
        repositories.mavenDeployer
        {
        	beforeDeployment
        	{
        		MavenDeployment deployment -> signing.signPom(deployment)
        	}
        	
            configuration = configurations.deployerJars
            
            snapshotRepository(url: "http://www2.activecomponents.org/nexus/content/repositories/snapshots/")
            {
                authentication(userName: "deployment", password: "laxlax")
            }
            repository(url: "http://www2.activecomponents.org/nexus/content/repositories/releases/")
            {
                authentication(userName: "deployment", password: "laxlax")
            }
        }
    }
}

task docs(type: Javadoc) {
    source subprojects.collect {project -> project.sourceSets.main.allJava }
    classpath = files(subprojects.collect {project -> project.sourceSets.main.compileClasspath})
    destinationDir = new File(projectDir, 'build/docs')
    options.links("http://docs.oracle.com/javase/7/docs/api/")
}

task srcZip(type: Zip) {
	buildDistributionSource(srcZip, stdexcl) 
}   

task srcZipPro(type: Zip) {
	buildDistributionSource(srcZipPro, proexcl) 
} 

def buildDistributionSource(task, excl) {
	task.archiveName = 'sources.zip'
    task.classifier = 'src'
    
    //from(sourceSets.main.allSource){}
    //from sourceSets*.allSource.srcDirs*.collect { relativePath(it) }.flatten()
    
    task.from('build.gradle'){ into('sources') }
    task.from('settings.gradle'){ into('sources') }
    
    subprojects.each {subproject ->
    	if(!isExcluded(excl, subproject.name))
		{
			task.from(subproject.projectDir.name) { include 'build.gradle' into 'sources/'+subproject.projectDir.name }
			task.from(subproject.sourceSets.main.java) { into 'sources/'+subproject.projectDir.name+'/src/main/java' }
			task.from(subproject.sourceSets.main.resources) { into 'sources/'+subproject.projectDir.name+'/src/main/resources' }
		}
	} 
	
	task.from('jadex-kernel-extension-envsupport-opengl/lib/gluegen-rt.jar') { into('sources/jadex-kernel-extension-envsupport-opengl/lib') }
	task.from('jadex-kernel-extension-envsupport-opengl/lib/jogl.jar') { into('sources/jadex-kernel-extension-envsupport-opengl/lib') }
}

def buildDistribution(task, excl) {
	println("diststart"+excl)

	task.duplicatesStrategy = DuplicatesStrategy.EXCLUDE

	subprojects.each {subproject ->
		if(!isExcluded(excl, subproject.name))
		{
			task.from(subproject.configurations.runtime) { into('lib') }
			task.from(subproject.jar) { into('lib') }
		}
		else
		{
			println("Excluded: "+subproject.name)
		}
	}
	 	
    //from(subprojects.configurations.runtime){ into('lib') }
    //from('subprojects.jar'){ into('lib') }
    //from('sourceSets.main.allSource') { into('src') }
    task.from('docs/junit-3.8.1.jar'){ into('lib') }
    
    //from('build/sources.zip')
    task.from('docs/junit-3.8.1.jar'){ into('lib') }
    task.from("jadex-platform-standalone-launch/build/lib/jadex-platform-standalone-launch-${version}.jar")
    task.from('build/jadex-example-project.zip')
    task.from('docs/readme.txt')
    task.from('docs/license.txt')
    task.from('docs/api-changes.txt')
    task.from('docs/jcc.settings.xml') 
    task.from('docs/default.settings.xml')
    task.from('docs/jadex.bat')
    task.from('docs/jadex_no_awareness.bat') 
    task.from('docs/jadex.sh')
    task.from('docs/jadex_no_awareness.sh')
    task.from('docs/bpmn_editor.bat')
    task.from('docs/bpmn_editor.sh')
    task.from('docs/howtostart.txt')
    println("distend")
}

task buildDist(type: Zip, dependsOn: srcZip) {
	buildDistribution(buildDist, stdexcl)
	from(srcZip.archivePath)
}

task buildDistPro(type: Zip, dependsOn: srcZipPro) {
	buildDistribution(buildDistPro, proexcl)
	//from(srcZipPro.archivePath)
	//from('jadex-platform-extension-management/win') { into('win') }
}

def isExcluded(excl, name)
{
	boolean ret = false;
	if(excl!=null)
	{
		for(ex in excl)
		{
			if(name.indexOf(ex)!=-1)
			{
				ret = true;
				break;
			}
		}
	}
	return ret;
}
