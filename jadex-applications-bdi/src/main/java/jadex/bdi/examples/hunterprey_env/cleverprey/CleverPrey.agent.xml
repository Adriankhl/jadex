<!--
	<H3>The clever prey.</H3>

	Wander, flee and eat behavior for preys.

	Three goal types are supported:<br>
	- Running away from hunters (maintain keep alone).<br>
	- Eating food if discovered (achieve eat_food).<br>
	- Searching for food (perform wander around).
-->

<agent xmlns="http://jadex.sourceforge.net/jadex"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://jadex.sourceforge.net/jadex 
	                    http://jadex.sourceforge.net/jadex-2.0.xsd"
	name="CleverPrey"
	package="jadex.bdi.examples.hunterprey_env.cleverprey">

	<imports>
		<import>jadex.adapter.base.envsupport.environment.space2d.*</import>
		<import>jadex.adapter.base.envsupport.environment.*</import>
		<import>jadex.adapter.base.envsupport.math.*</import>
		<import>java.util.Arrays</import>
	</imports>

	<beliefs>
		<!-- Environment. -->
		<belief name="env" class="Grid2D">
			<fact>(Grid2D)$scope.getApplicationContext().getSpace("my2dspace")</fact>
 		</belief>
 		
 		<!-- Myself. -->
 		<belief name="myself" class="ISpaceObject">
 			<fact>$beliefbase.env.getOwnedObjects($scope.getAgentIdentifier())[0]</fact>
 		</belief>

 		<!-- The currently seen food. -->
 		<beliefset name="seen_food" class="ISpaceObject"/>

 		<!-- The known food (seen and out of sight). -->
 		<beliefset name="known_food" class="ISpaceObject"/>
	</beliefs>
	
	<goals>
		<!-- A goal to find some food. -->
		<maintaingoal name="find_food">
			<maintaincondition language="jcl">
				$beliefbase.seen_food.length>0
			</maintaincondition>
		</maintaingoal>
		
		<!-- Goal to eat any seen food (activated in order of distance). -->
		<achievegoal name="eat_food">
			<parameter name="food" class="ISpaceObject">
				<value>$food</value>
			</parameter>
			<unique dummy="true"/>
			<creationcondition language="jcl">
 				ISpaceObject $food &amp;&amp; $food.getType().equals("food")
 				&amp;&amp; Arrays.asList($beliefbase.seen_food).contains($food)
			</creationcondition>
			<dropcondition language="jcl">
 				!Arrays.asList($beliefbase.seen_food).contains($goal.food)
			</dropcondition>
			<deliberation>
				<inhibits ref="eat_food" language="jcl">
					$beliefbase.env.getDistance((IVector2)$beliefbase.myself.position, (IVector2)$goal.food.position).getAsInteger()
					&lt; $beliefbase.env.getDistance((IVector2)$beliefbase.myself.position, (IVector2)$ref.food.position).getAsInteger()
					
					// Hack!!! Required, because cardinality=1 not supported in conjunction with instance-level inhibition.
					// When same distance order by space object id.
					|| ($beliefbase.env.getDistance((IVector2)$beliefbase.myself.position, (IVector2)$goal.food.position).getAsInteger()
						==$beliefbase.env.getDistance((IVector2)$beliefbase.myself.position, (IVector2)$ref.food.position).getAsInteger()
						&amp;&amp; $goal.food.getId() &lt; $ref.food.getId())					
				</inhibits>
			</deliberation>
		</achievegoal>
	</goals>
	
	<plans>
		<plan name="wander_plan">
			<body class="WanderPlan"/>
			<trigger>
				<goal ref="find_food"/>
			</trigger>
		</plan>
		<plan name="move_plan" priority="1">
			<parameter name="food" class="ISpaceObject">
				<value>
					select one $food from ISpaceObject $food in $beliefbase.known_food
					order by $beliefbase.env.getDistance((IVector2)$beliefbase.myself.getProperty("position"), (IVector2)$food.getProperty("position")).getAsInteger()
				</value>
			</parameter>
			<body class="EatPlan"/>	<!-- Eat plan starts moving towards food and gets aborted when food come sin vision range. -->
			<trigger>
				<goal ref="find_food"/>
			</trigger>
			<precondition>$beliefbase.known_food.length>0</precondition>
		</plan>
		<plan name="eat_plan">
			<parameter name="food" class="ISpaceObject">
				<goalmapping ref="eat_food.food"/>
			</parameter>
			<body class="EatPlan"/>
			<trigger>
				<goal ref="eat_food"/>
			</trigger>
		</plan>
	</plans>
	
	<properties>
		<!-- The environment may throw exceptions when executing property listeners
			and these listeners are not valid any longer. This leads to normal plan
			failure and can therefore be ignored. -->
		<property name="logging.level">java.util.logging.Level.WARNING</property>
		<property name="debugging">false</property>
    </properties>

	<configurations>
		<configuration name="Clever">
			<goals>
				<initialgoal ref="find_food"/>
			</goals>
		</configuration>
	</configurations>
</agent>