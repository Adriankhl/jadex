<?xml version="1.0" encoding="UTF-8"?>
<!--
	<H3>The Cleaner Agent.</H3>

	The agent mainly has 3 top-level goals:<br>
	- Searching for waste (perform lookforwaste).<br>
	- Cleaning up waste (achieve cleanup).<br>
	- Keep the battery loaded (maintain battery loaded).<br><br>

	To achieve this goals it uses various
	subgoals for decomposition of the overall
	tasks.
-->
<agent xmlns="http://jadex.sourceforge.net/jadex"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://jadex.sourceforge.net/jadex 
	                    http://jadex.sourceforge.net/jadex-2.0.xsd"
	name="Cleaner"
	package="jadex.bdi.examples.cleanerworld2.cleaner">
	
	<imports>
		<import>java.util.*</import>
		<import>jadex.adapter.base.clock.*</import>
		<import>jadex.bdi.planlib.simsupport.environment.*</import>
		<import>jadex.bdi.planlib.simsupport.common.math.*</import>
		<import>jadex.commons.Tuple</import>
	</imports>
	
	<capabilities>
    	<capability name="simcap" file="jadex.bdi.planlib.simsupport.simcap.SimAgent"/>
	</capabilities>
	
	<beliefs>
		<!-- Known waste bins and positions (id->position) -->
		<beliefset name="waste_bins" class="Tuple"/>
		
		<!-- Battery state -->
		<belief name="battery_state" class="String">
			<fact>"charged"</fact>
		</belief>
		<!-- Maximum waste capacity -->
		<belief name="max_waste_capacity" class="Integer">
			<fact>3</fact>
		</belief>
		<!-- Current waste capacity -->
		<belief name="waste_capacity" class="Integer">
			<fact>3</fact>
		</belief>
		<!-- Current waste target -->
		<belief name="waste_target" class="Integer">
			<fact>null</fact>
		</belief>
		<!-- Last known waste target position -->
		<belief name="waste_target_position" class="IVector2">
			<fact>null</fact>
		</belief>
		<!-- Current waste search waypoint -->
		<belief name="waste_search_waypoint" class="IVector2">
			<fact>null</fact>
		</belief>
		<!-- Name of the simulation environment -->
		<belief name="environment_name" class="String">
			<fact>new String("CleanerWorld2")</fact>
		</belief>
		<!-- The simulation object representing the cleaner -->
    	<belief name="simobject_id" class="Integer">
      		<fact>null</fact>
    	</belief>
  	</beliefs>
	
	<goals>
		<!-- Observe the battery state. -->
		<maintaingoal name="maintainbatteryloaded">
			<deliberation>
				<inhibits ref="look_for_waste" inhibit="when_in_process"/>
				<inhibits ref="dispose_waste" inhibit="when_in_process"/>
				<inhibits ref="achieve_cleanup" inhibit="when_in_process"/>
			</deliberation>
			<!-- Engage in actions when the state is low. -->
 			<maintaincondition>
				?rbelief = (belief (element_has_model ?mbelief) (belief_has_fact ?fact))
				?mbelief = (mbelief (element_has_name "battery_state"))
				(test (!= ?fact "low"))
 			</maintaincondition>
			<!-- The goal is satisfied when the charge state is 1.0. -->
			<targetcondition>
				?rbelief = (belief (element_has_model ?mbelief) (belief_has_fact ?fact))
				?mbelief = (mbelief (element_has_name "battery_state"))
				(test (== ?fact "charged"))
 			</targetcondition>
		</maintaingoal>
		
		<!-- Dispose the waste. -->
		<achievegoal name="dispose_waste">
			<creationcondition>
				?rbelief = (belief (element_has_model ?mbelief) (belief_has_fact 0))
				?mbelief = (mbelief (element_has_name "waste_capacity"))
			</creationcondition>
			<deliberation cardinality="1">
				<inhibits ref="achieve_cleanup"/>
				<inhibits ref="look_for_waste"/>
			</deliberation>
		</achievegoal>
		
		<!-- Clean up some waste. -->
		<achievegoal name="achieve_cleanup">
			<!-- Adopt when we have a target -->
			<creationcondition>
				?rbelief = (belief (element_has_model ?mbelief) (belief_has_fact ?fact))
				?mbelief = (mbelief (element_has_name "waste_target"))
				(test (!= ?fact null))
			</creationcondition>
			<deliberation cardinality="1">
				<inhibits ref="look_for_waste"/>
			</deliberation>
		</achievegoal>
		
		<!-- Look out for waste when nothing better to do. -->
		<performgoal name="look_for_waste" retry="true" exclude="never">
			<contextcondition>
				?wtrbelief = (belief (element_has_model ?wtmbelief) (belief_has_fact null))
				?wtmbelief = (mbelief (element_has_name "waste_target"))
				?rbelief = (belief (element_has_model ?mbelief) (belief_has_fact null))
				?mbelief = (mbelief (element_has_name "waste_search_waypoint"))
			</contextcondition>
 		</performgoal>
 		
 		<!-- Sets a new destination for the cleaner. -->
 		<achievegoal name="set_destination">
 			<!-- Destination of the cleaner -->
			<parameter name="destination" class="IVector2"/>
 		</achievegoal>
 		
 		<!-- Stops the cleaner. -->
 		<achievegoal name="stop"/>
 		
 		<!-- Enable the waste sensor -->
 		<achievegoal name="enable_waste_sensor"/>
		
	    <achievegoalref name="sim_create_object">
        	<concrete ref="simcap.sim_create_object"/>
    	</achievegoalref>
    	
    	<achievegoalref name="sim_get_position">
        	<concrete ref="simcap.sim_get_position"/>
    	</achievegoalref>
    	
    	<achievegoalref name="sim_set_velocity">
        	<concrete ref="simcap.sim_set_velocity"/>
    	</achievegoalref>
    	
    	<achievegoalref name="sim_set_destination">
    		<concrete ref="simcap.sim_set_destination"/>
		</achievegoalref>
		
		<achievegoalref name="sim_remove_task">
    		<concrete ref="simcap.sim_remove_task"/>
		</achievegoalref>
		
		<performgoalref name="sim_perform_action">
    		<concrete ref="simcap.sim_perform_action"/>
		</performgoalref>
		
		<achievegoalref name="sim_get_random_position">
    		<concrete ref="simcap.sim_get_random_position"/>
		</achievegoalref>
		
		<achievegoalref name="sim_add_environment_process">
    		<concrete ref="simcap.sim_add_environment_process"/>
		</achievegoalref>
		
		<achievegoalref name="sim_remove_environment_process">
    		<concrete ref="simcap.sim_remove_environment_process"/>
		</achievegoalref>
		
		<achievegoalref name="sim_connect_environment">
    		<concrete ref="simcap.sim_connect_environment"/>
		</achievegoalref>
  	</goals>
  	
  	<plans>
  		<plan name="dispose_waste_plan">
  			<body class="DisposeWastePlan"/>
  			<trigger>
				<goal ref="dispose_waste"/>
			</trigger>
  		</plan>
  		
  		<plan name="achieve_cleanup_plan">
  			<body class="AchieveCleanupPlan"/>
  			<trigger>
				<goal ref="achieve_cleanup"/>
			</trigger>
  		</plan>
  		
  		<plan name="look_for_waste_plan">
  			<body class="LookForWastePlan"/>
  			<trigger>
				<goal ref="look_for_waste"/>
			</trigger>
  		</plan>
  		
  		<plan name="enable_waste_sensor_plan">
  			<body class="EnableWasteSensorPlan"/>
  			<trigger>
				<goal ref="enable_waste_sensor"/>
			</trigger>
  		</plan>
  		
  		<plan name="set_destination_plan">
  			<parameter name="destination" class="IVector2">
				<goalmapping ref="set_destination.destination"/>
			</parameter>
  			<body class="SetDestinationPlan"/>
  			<trigger>
				<goal ref="set_destination"/>
			</trigger>
  		</plan>
  		
  		<plan name="stop_plan">
  			<body class="StopPlan"/>
  			<trigger>
				<goal ref="stop"/>
			</trigger>
  		</plan>
  		
  		<!-- Event handling -->
 		
 		<plan name="low_battery_event_plan">
			<body class="LowBatteryEventPlan"/>
			<trigger>
 				<internalevent ref="simulation_event">
					<match>$event.getParameter("type").getValue().equals("battery_low")</match>
				</internalevent>
			</trigger>
		</plan>
		
		<plan name="waste_bin_found_event_plan">
			<body class="WasteBinFoundEventPlan"/>
			<trigger>
 				<internalevent ref="simulation_event">
					<match>$event.getParameter("type").getValue().equals("waste_bin_found")</match>
				</internalevent>
			</trigger>
		</plan>
		
		<plan name="waste_found_event_plan">
			<body class="WasteFoundEventPlan"/>
			<trigger>
 				<internalevent ref="simulation_event">
					<match>$event.getParameter("type").getValue().equals("waste_found")</match>
				</internalevent>
			</trigger>
		</plan>
		
		<plan name="destination_reached_event_plan">
			<body class="DestinationReachedEventPlan"/>
			<trigger>
 				<internalevent ref="simulation_event">
					<match>$event.getParameter("type").getValue().equals(SimulationEvent.DESTINATION_REACHED)</match>
				</internalevent>
			</trigger>
		</plan>
  		
    	<!-- Initialization Plan. -->
    	<plan name="initialization">
      		<body class="InitializeCleanerPlan"/>
    	</plan>
    </plans>
    
    <events>
    	<!-- Reached destination in dispose mode. -->
    	<internalevent name="reached_dispose_destination_event"/>
    	<!-- Reached waste event. -->
    	<internalevent name="reached_waste_event"/>
    	<!-- Generic simulation event. -->
    	<internaleventref name="simulation_event">
    		<concrete ref="simcap.simulation_event"/>
    	</internaleventref>
	</events>
    
  	<configurations>
    	<configuration name="default">
      		<plans>
        		<initialplan ref="initialization"/>
      		</plans>
    	</configuration>
  	</configurations>
</agent>