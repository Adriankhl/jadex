<?xml version="1.0" encoding="UTF-8"?>
<!--
	<H3>The mars world application descriptor</H3>

	Can be used to launch the mars world example.<br>

	It consists of three different kinds of agents:<br>
	- <b>Sentry agents</b> are responsible for examining ore locations<br>
		A ore capacity is shown on the map when an ore location was examined.<br>
	- <b>Production agents</b> produce ore at available ore location.<br>
	- <b>Carry agents</b> are able to carry ore to the base.<br><br>

	Objective is to carry as much ore as possible to the<br>
	home base in a predefined mission time.<br>
-->
<applicationtype xmlns="http://jadex.sourceforge.net/jadex"
	xmlns:agr="http://jadex.sourceforge.net/jadex-agrspace"
	xmlns:env="http://jadex.sourceforge.net/jadex-envspace"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://jadex.sourceforge.net/jadex 
	                    http://jadex.sourceforge.net/jadex-application-2.0.xsd
	                    http://jadex.sourceforge.net/jadex-agrspace 
	                    http://jadex.sourceforge.net/jadex-agrspace-2.0.xsd
	                    http://jadex.sourceforge.net/jadex-envspace 
	                    http://jadex.sourceforge.net/jadex-envspace-2.0.xsd"
	name="SpaceWorld3d" package="jadex.bdi.examples.spaceworld3d">
	
	<imports>
		<import>jadex.extension.envsupport.environment.space3d.*</import>
		<import>jadex.extension.envsupport.environment.DeltaTimeExecutor</import>
		<import>jadex.extension.envsupport.math.*</import>
		<import>jadex.extension.envsupport.dataview.*</import>
		<import>java.text.SimpleDateFormat</import>
		<import>java.util.Date</import>
		<import>jadex.extension.envsupport.observer.perspective.*</import>
		<import>jadex.bdi.examples.spaceworld3d.carry.*</import>
		<import>jadex.bdi.examples.spaceworld3d.producer.*</import>
		<import>jadex.bdi.examples.spaceworld3d.sentry.*</import>
		<import>jadex.bdi.examples.spaceworld3d.movement.*</import>
		<import>jadex.extension.envsupport.evaluation.*</import>
		<import>jadex.extension.envsupport.observer.gui.plugin.*</import>
		<import>jadex.commons.future.*</import>
		<import>jadex.bridge.service.*</import>
		<import>jadex.bridge.service.search.*</import>
		<import>jadex.bridge.service.types.clock.IClockService</import>
	</imports>
	
	<extensiontypes>
		<agr:agrspacetype name="marsagrspace">
			<agr:grouptype name="marsteam">
				<agr:roles>
					<agr:role name="sentry" min="1" max="1" />
					<agr:role name="producer" min="1" />
					<agr:role name="carrier" min="1" max="-1" />
				</agr:roles>
			</agr:grouptype>
		</agr:agrspacetype>

		<env:envspacetype name="3dspace" class="ContinuousSpace3D" width="1" height="1" depth="1">
			<env:objecttypes>
				<env:objecttype name="target">
					<env:property name="tick360" class="double" dynamic="true">$properties.clock.getTick()%360
					</env:property>	
					<env:property name="abbau" class="boolean" dynamic="true">								
						$object.getProperty("state").equals("analyzed")
						&amp;&amp; ($object.getProperty("ore")!=0 &amp;&amp; $object.getProperty("capacity")!=0)
					</env:property>
					<env:property name="ore" class="int">0</env:property>
					<env:property name="capacity" class="int">0</env:property>
					<env:property name="state" class="String">"unknown"</env:property>
				</env:objecttype>
				<env:objecttype name="sentry">
				<env:property name="tick360" class="double" dynamic="true">$properties.clock.getTick()%360
					</env:property>	
					<env:property name="radarsize" class="Vector3Double" dynamic="true">new Vector3Double(0.1*(($properties.clock.getTick())%10),0.2,0.1*(($properties.clock.getTick())%10))
					</env:property>	
					<env:property name="vision" class="double">0.1</env:property>
					<env:property name="speed" class="double">0.05</env:property>
					<env:property name="position" class="IVector3" dynamic="true">$space.getSpaceObjectsByType("homebase")[0].getProperty("position")</env:property>
				</env:objecttype>
				<env:objecttype name="producer">
					<env:property name="vision" class="double">0.05</env:property>
					<env:property name="speed" class="double">0.1</env:property>
					<env:property name="position" class="IVector3" dynamic="true">$space.getSpaceObjectsByType("homebase")[0].getProperty("position")</env:property>
				</env:objecttype>
				<env:objecttype name="carry">
					<env:property name="vision" class="double">0.05</env:property>
					<env:property name="speed" class="double">0.15</env:property>
					<env:property name="ore" class="int">0</env:property>
					<env:property name="capacity" class="int">20</env:property>
					<env:property name="position" class="IVector3" dynamic="true">$space.getSpaceObjectsByType("homebase")[0].getProperty("position")</env:property>
				</env:objecttype>
				<env:objecttype name="homebase">
					<env:property name="ore" class="int">0</env:property>
					<env:property name="text" class="String" dynamic="true">
						"Collected ore: "+$object.getProperty("ore")+" \n"+
						"Remaining time: "+new SimpleDateFormat("mm:ss").format(new Date(Math.max(0, $object.getProperty("missiontime")
							- $properties.clock.getTime())))
					</env:property>
				</env:objecttype>
			</env:objecttypes>
						
			<env:tasktypes>
				<env:tasktype name="move" class="MoveTask" />
				<env:tasktype name="analyze" class="AnalyzeTargetTask" />
				<env:tasktype name="produce" class="ProduceOreTask" />
				<env:tasktype name="load" class="LoadOreTask" />
			</env:tasktypes>			
						
			<env:dataviews>
				<env:dataview name="all_view" class="GeneralDataView3D" />
			</env:dataviews>
						
			<env:avatarmappings>
				<env:avatarmapping componenttype="Sentry" objecttype="sentry"/>
				<env:avatarmapping componenttype="Producer" objecttype="producer"/>
				<env:avatarmapping componenttype="Carry" objecttype="carry"/>
			</env:avatarmappings>
			
			
			
			<env:perspectives>
			<env:perspective name="Complex3D" class="Perspective3D" opengl="true" >

				
				<env:drawable3d objecttype="static" hasSpaceobject="false" width="1" height="1" depth="1">
				<env:property name="rotate90" dynamic="false">new Vector3Double((Math.PI/180)*90, 0, 0)</env:property>

					<env:sky skypath="jadex3d/textures/sky/sky01/" west="west.jpg" east="east.jpg" north="north.jpg" south="south.jpg" up="up.jpg" down="down.jpg" isSphere="false" />  
						<!--  
					<env:rndterrain width="1" height="0.2" depth="1"  
		 		tiles="512" iterations="1000" minradius="25" maxradius="100" seed="4"
					terrapath="jadex3d/textures/terrain/terrain01/" alphamap="alphamap.png" 
					texture01="grass.jpg" tex01val="64" texture02="dirt.jpg" tex02val="32" texture03="road.jpg" tex03val="128" />
					-->
				</env:drawable3d>
				
				<!-- H O M E B A S E -->
				<env:drawable3d objecttype="homebase" width="0.2" height="0.2" depth="0.2" rotation3d="false">
					<env:property name="oresize" dynamic="true">new Vector3Double(0.72f,Math.sqrt(((Number)$object.getProperty("ore")).intValue()/1000.0),0.72f)</env:property>
					<env:property name="textda" dynamic="true">$object.getProperty("text")</env:property>
					<env:property name="rotate" dynamic="false">new Vector3Double((Math.PI/180)*90, 0, 0)</env:property>
					<env:property name="rotate270" dynamic="false">new Vector3Double((Math.PI/180)*270, 0, 0)</env:property>
					
				
				
				
					<env:text3d  width="2" height="2" depth="1"  x="0" y="4" z="0" text="$textda$" color="#FFFFFFFF"></env:text3d>
				
					<!--Box for Ore -->
					<env:box  width="1" height="0.01" depth="1" x="-1" y="0.01" z="1" color="#D2B48CFF" />

					<env:box  width="0.001" height="0.15" depth="1.0" x="-2" y="0.15" z="1" color="#FF7F24FF" />
					<env:box  width="1.0" height="0.15" depth="0.01" x="-1" y="0.15" z="2" color="#FF7F24FF" />
					
					

					<env:sphere size="oresize" x="-1" y="0" z="1"  color="#FFA54FFF">
							<env:drawcondition>((Number)$object.getProperty("ore")).intValue()>0</env:drawcondition>
					</env:sphere>
				

				</env:drawable3d>
				
				<!--ERZVORKOMMEN  -->
				<env:drawable3d objecttype="target" width="0.2" height="0.2" depth="0.2">
				  	<env:property name="oresize" dynamic="true">new Vector3Double(0.5,Math.sqrt(((Number)$object.getProperty("ore")).intValue()/2000.0),0.5)</env:property>
				  	<env:property name="capa" dynamic="true">new Vector3Double(Math.sqrt(((Number)$object.getProperty("capacity")).intValue()/400.0))</env:property>
					<env:property name="rotate90" dynamic="false">new Vector3Double((Math.PI/180)*90, 0, 0)</env:property>
					<env:property name="rotated" dynamic="true">new Vector3Double((Math.PI/180)*$object.getProperty("tick360")*8, 0, 0)</env:property>

						<!-- Nullpunkt  -->
						<env:sphere width="0.02" height="0.02" depth="0.02" x="0" y="0" z="0" color="#FFB90FFF" />
						
						<!--Abgebautes erz  -->
						<env:sphere size="capa"  x="0" y="0" z="0" color="#FFB90FFF">
							<env:drawcondition>((Number)$object.getProperty("capacity")).intValue()>0</env:drawcondition>
						</env:sphere>
						
						<!-- Markierung  -->
						<env:cylinder height="0.70" radius="0.05" rotation="rotate90" x="0" y="0.35" z="0" color="#FFFF00FF" >
							<env:drawcondition>
								$object.getProperty("state").equals("analyzed")
								&amp;&amp; ($object.getProperty("ore")!=0 || $object.getProperty("capacity")!=0)
							</env:drawcondition>
						</env:cylinder>
						<env:dome radius="0.1" samples="30" x="0" y="0.70" z="0" color="#FF4500FF" >
							<env:drawcondition>
								$object.getProperty("state").equals("analyzed")
								&amp;&amp; ($object.getProperty("ore")!=0 || $object.getProperty("capacity")!=0)
							</env:drawcondition>
						</env:dome>


						<!-- Noch nicht Analysiert -->
						<env:sphere width="0.05" height="0.05" depth="0.05" x="0" y="0" z="0.0" color="#00FF00FF">
							<env:drawcondition>
							$object.getProperty("state").equals("unknown")
							</env:drawcondition>
				   		</env:sphere>
						
						<!-- Endzustand, Analysiert  -->
						<env:sphere width="0.06" height="0.06" depth="0.06" x="0" y="0" z="0.0" color="#BEBEBEFF">
				   			<env:drawcondition>
				   			((Number)$object.getProperty("capacity")).intValue()==0
				   			&amp;&amp; 
				   			$object.getProperty("state").equals("analyzed")
				   			</env:drawcondition>
				   		</env:sphere>
				   	
			</env:drawable3d>
				

				<env:drawable3d objecttype="sentry" width="0.18" height="0.18" depth="0.18">
				<env:property name="radarsize2" dynamic="true">$object.getProperty("radarsize")</env:property>
				<env:property name="visionsize" dynamic="true">new Vector3Double($object.getProperty("vision").doubleValue()*10,0.2f,$object.getProperty("vision").doubleValue()*10)</env:property>
				<env:property name="rotate" dynamic="false">new Vector3Double((Math.PI/180)*90, 0, 0)</env:property>
				<env:property name="rotatedyn" dynamic="true">new Vector3Double(0, (Math.PI/180)*$object.getProperty("tick360")*10, 0)</env:property>
				
				
						<env:text3d  width="1" height="1" depth="1" x="-1" y="2.0" z="1" text="moin" color="#000000FF" />
						<!--  Radarkreisel -->
						<env:torus width="1" height="0.75" depth="1" rotation="rotatedyn" innerRadius="0.035" outerRadius="0.3" radialSamples="10" circleSamples="15" x="0.05" y="0.8" z="0.0" />
						<env:box  width="0.45" height="0.01" depth="0.01" rotation="rotatedyn"  x="0.05" y="0.8" z="0.0" />
						<env:box  width="0.01" height="0.01" depth="0.25" rotation="rotatedyn"  x="0.05" y="0.8" z="0.0"  color="#FF0000FF"/>
						<env:cylinder rotation="rotate" height="0.5" radius="0.03"  x="0.05" y="0.7" z="0.0" color="#FFFFFFFF"/>
						
						<env:object3d width="1.7" height="1.7" depth="1.7" x="0" y="0.0" z="0.0" modelpath="jadex3d/models/vehicles/tank/sentrytank.j3o" hasLightMaterials="false"/> 
						
						
						<!--  Sonstiges -->
						<env:sphere  size="radarsize2" x="0.0" y="0.0" z="0.0" color="#ADFF2F15" />
						<env:sphere  size="visionsize" x="0.0" y="0.0" z="0.0" color="#FFFF0010" />
					</env:drawable3d>
					
					<env:drawable3d objecttype="carry" width="0.15" height="0.15" depth="0.15">
				 	<env:property name="visionsize" dynamic="true">new Vector3Double($object.getProperty("vision").doubleValue()*10,0.2f,$object.getProperty("vision").doubleValue()*10)</env:property>
					<env:property name="-turn90" dynamic="false">new Vector3Double(0, -(Math.PI/180)*90, 0)</env:property>	
						<env:sphere  size="visionsize"  x="0" y="0.00" z="0"  color="#FFFF0010" />
						
						
						 <env:object3d width="1.5" height="1.5" depth="1.5" rotation="-turn90" modelpath="jadex3d/models/vehicles/forklift/forklift.j3o" hasLightMaterials="false"/> 
					
						<env:box width="0.2" height="0.2" depth="0.2"  x="0.0" y="0.22" z="0.4"  color="#FFFFFFFF" texturepath="jadex3d/textures/solid/wood.jpg">
							<env:drawcondition>((Number)$object.getProperty("ore")).intValue()>0</env:drawcondition>
						</env:box>
					</env:drawable3d>
					
					<env:drawable3d objecttype="producer" width="0.15" height="0.15" depth="0.15">
					<env:property name="visionsize" dynamic="true">new Vector3Double($object.getProperty("vision").doubleValue()*10,0.2f,$object.getProperty("vision").doubleValue()*10)</env:property>
					<env:property name="turn90" dynamic="false">new Vector3Double(0, (Math.PI/180)*90, 0)</env:property>
					<env:text3d  width="2" height="2" depth="2"   x="0" y="1.5" z="0" text="moin" color="#FFFFFFFF" />	
						
						
						<!-- Assertion from Jmonkey -->
						
 						<env:object3d width="0.20" height="0.2" depth="0.2" x="0" y="0.25" z="0.0"  rotation="turn90" modelpath="jadex3d/models/vehicles/digger/digger.j3o" hasLightMaterials="false"/> 
						<env:sphere  size="visionsize" x="0" y="0.00" z="0" color="#FFFF0010" />
					</env:drawable3d>
					
				</env:perspective>	
				
				
				
			</env:perspectives>
				

			<!-- executor -->
			<env:spaceexecutor class="DeltaTimeExecutor">
				<env:property name="space">$space</env:property>
				<env:property name="tick">true</env:property>
			</env:spaceexecutor>
		</env:envspacetype>
	</extensiontypes>

	<componenttypes>
		<componenttype name="Sentry" filename="jadex/bdi/examples/spaceworld3d/sentry/Sentry.agent.xml"/>
		<componenttype name="Producer" filename="jadex/bdi/examples/spaceworld3d/producer/Producer.agent.xml"/>
		<componenttype name="Carry" filename="jadex/bdi/examples/spaceworld3d/carry/Carry.agent.xml"/>
	</componenttypes>
	
	<properties>
		<property name="clock" class="IFuture">
			SServiceProvider.getService($component.getServiceProvider(), IClockService.class, RequiredServiceInfo.SCOPE_PLATFORM)
		</property>
	</properties>

	<configurations>
		
 		
 		
 		<configuration name="Multi">
			<extensions>
				<agr:agrspace name="myagrspace" type="marsagrspace">
					<agr:group name="mymarsteam" type="marsteam">
						<agr:position role="sentry" componenttype="Sentry" />
						<agr:position role="producer" componenttype="Producer" />
						<agr:position role="carrier" componenttype="Carry" />
					</agr:group>
				</agr:agrspace>
	
				<env:envspace name="my3dspace" type="3dspace" width="2" height ="2" depth ="2">
					<env:objects>
						<env:object type="homebase">
							<env:property name="space">$space</env:property><!-- hack!!! -->
							<env:property name="missiontime">
								3000000 + $properties.clock.getTime()
							</env:property>
						</env:object>
						<env:object type="target" number="50">
							<env:property name="ore">Math.random()>0.2 ? (Integer)(5+Math.random()*35)*5 : 0</env:property>
						</env:object>
					</env:objects>
					<env:observers>
						<env:observer name="MarsWorld" dataview="view_all" perspective="icons"/>
					</env:observers>
	 			</env:envspace>
			</extensions>
			<components>
				<component type="Sentry" number="1"/> <!-- todo: support more than one sentry (requires coordination between sentries) -->
  				<component type="Producer" number="5"/>
				<component type="Carry" number="10"/>
			</components>
 		</configuration>
 		
 		
 		<configuration name="1 Sentry / 2 Producers / 3 Carries">
			<extensions>
				<agr:agrspace name="myagrspace" type="marsagrspace">
					<agr:group name="mymarsteam" type="marsteam">
						<agr:position role="sentry" componenttype="Sentry" />
						<agr:position role="producer" componenttype="Producer" />
						<agr:position role="carrier" componenttype="Carry" />
					</agr:group>
				</agr:agrspace>
	
				<env:envspace name="my3dspace" type="3dspace">
					<env:objects>
						<env:object type="homebase">
							<env:property name="position">new Vector3Double(0.3,0.3, 0.3)</env:property>
							<env:property name="space">$space</env:property><!-- hack!!! -->
							<env:property name="missiontime">
								90000 + $properties.clock.getTime()
							</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(0.1, 0.15, 0.2)</env:property>
							<env:property name="ore">0</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(0.05,0.2 ,0.7)</env:property>
							<env:property name="ore">200</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(0.5,0.5 ,0.6)</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(0.8,0.0 ,0.1)</env:property>
							<env:property name="ore">50</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(0.7,0.45 ,0.4)</env:property>
							<env:property name="ore">100</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(0.8,0.8,0.8)</env:property>
							<env:property name="ore">75</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(0.0,0.0,0.0)</env:property>
							<env:property name="ore">75</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(1.0,1.0,1.0)</env:property>
							<env:property name="ore">75</env:property>
						</env:object>
						<env:object type="target">
							<env:property name="position">new Vector3Double(1.0,0.0,1.0)</env:property>
							<env:property name="ore">75</env:property>
						</env:object>
					</env:objects>
					
					<env:dataproviders>
						<env:dataprovider name="homebase_ore">
							<env:source name="$homebase" objecttype="homebase">
							</env:source>
							<env:data name="time">$time</env:data>
							<env:data name="ore_amount">$homebase.ore</env:data>
						</env:dataprovider>
					</env:dataproviders>
			
					<env:dataconsumers>
						<env:dataconsumer name="ore_chart" class="XYChartDataConsumer">
							<env:property name="dataprovider">"homebase_ore"</env:property>
							<env:property name="title">"Ore in homebase"</env:property>
							<env:property name="labelx">"Time"</env:property>
							<env:property name="labely">"Ore"</env:property>
							<env:property name="maxitemcount">500</env:property>
							<env:property name="legend">false</env:property>
							
							<!-- Defines a normal series. -->
							<env:property name="seriesname">"Ore"</env:property>
							<env:property name="valuex">"time"</env:property>
							<env:property name="valuey">"ore_amount"</env:property>
						</env:dataconsumer>
					</env:dataconsumers>
					
					<env:observers>
						<env:observer name="SpaceWorld" dataview="view_all" perspective="icons">
							<env:plugin name="evaluation" class="EvaluationPlugin">
								<env:property name="component_0">((AbstractChartDataConsumer)$space.getDataConsumer("ore_chart")).getChartPanel()</env:property>
							</env:plugin>
						</env:observer>
					</env:observers>
	 			</env:envspace>
			</extensions>
			<components>
				<component type="Sentry" number="1"/>
  				<component type="Producer" number="2"/>
				<component type="Carry" number="3"/>
			</components>
 		</configuration>

	</configurations>

</applicationtype>
