// configure here:
def junit = false;
def deployDists = false;

def defaultGradleArgs = " --info --stacktrace"

if (!junit) {
    defaultGradleArgs += " -x test"
}


node { // a node is a step with workspace, can be distributed
    stage ('checkout') { // only for display purposes
        git url: 'ssh://jenkins@repo.actoron.com:20000/repositories/jadex', branch: 'master'
        echo "testing jenkins with pipeline"
        stash name: 'sources'
    }

    def version
    // TODO determine version by checking how many commits since last release tag?
    //   def v = version(readFile('pom.xml'))

    stage ('generate Version') {
        // TODO: reset version number on new minor (or patch?) release:
        // withEnv(['NEXT_BUILD_NUMBER=5']) { ... }
        version = VersionNumber([versionNumberString: '${BUILDS_ALL_TIME}', versionPrefix: ''])
        echo "building version:" + version
    }

    withEnv(['BUILD_VERSION_SUFFIX='+version]) {
        stage('genDepList') {
            sh './gradlew gendeplist'
        }

        stage('jadex-gradle-plugin') {
//            sh 'echo dummystep'
//            sleep 10

            sh './gradlew -Pdist=addongradleplugin clean build test install' + defaultGradleArgs
            if (junit) junit '**/test-results/*.xml'
        }

        stage('jadex-gradle') {
//            sh 'echo dummystep'
//            sleep 10

            // build everything but dont zip dists yet
            withX {
                sh './gradlew -Pdist=publishdists clean build' + defaultGradleArgs
            }
            if (junit) junit '**/test-results/*.xml'
            stash name: 'compiled', includes: '*'
        }


    }
}


parallel (
    'deployDists': {
        if (deployDists) {
            def dists = ['minimal', 'standard'] // todo add dists
            def checkDists = [:];

            node {
                stage('create dists') {
                    //            sh 'echo dummystep'
                    //            sleep 10

                    withX {
                        sh './gradlew -Pdist=publishdists distZips' + defaultGradleArgs
                    }
                    if (junit) junit '**/test-results/*.xml'
                    stash name: 'dists', includes: '*'
                    stash name: 'distsources', includes: 'build/distributions/sources/*'
                }
            }

            for (int i = 0; i < dists.size(); i++) {
                def distName = dists[i];
                checkDists["checkdist${distName}"] = {
                    node {
//                        sh 'echo dummystep'
//                        sleep 30
                        deleteDir()
                        unstash 'distsources'
                        dir('build/distributions/sources') {
                            //sh 'if [ -d "sources" ]; then rm -r "sources";fi'
                            sh "unzip jadex-${distName}*-sources.zip"
                            // todo check dists
                        }
                    }
                }
            }

            node {
                stage('check distributions') {
                    parallel checkDists
                }
            }

            // todo deploy dist
        } else {
            echo "nothing to do, deployDists is disabled"
        }
    },

    'docs': {
        node {
            // todo: dummy
            sh 'echo dummystep'
            sleep 30
            deleteDir()
            unstash 'sources'
            sh './gradlew -b docs/mkdocs-ng/build.gradle clean buildDocsZip buildDocsPdf'
            sh './gradlew -Pdist=addonjavadoc clean javadocZip'
        }
    }
)


// todo deployment
def withX(func) {
    wrap([$class: 'Xvnc', useXauthority: true]) {
        func()
    }
}